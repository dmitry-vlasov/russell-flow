import lingo/linecolumn;
import parse/ru_load;
import parse/ru_parse;
import ru_usage;

ruPlace2s(place : RuPlace) -> string {
	if (place.file == "" || place.pos == -1) "" else {
		code = getFileContent(place.file);
		resolver = makeLineResolver(code);
		pos = findLine(resolver, place.pos);
		place.file + ": line " + i2s(pos.lineno) + ", col " + i2s(pos.column)
	}
}

main() -> void {
	println("Russell prover (3rd generation)");
	println("");
	onError = \err, places -> 
		println(err + "\n" + strGlue(map(places, ruPlace2s), "\n"));
	switch (ruMakeConf(onError)) {
		Some(conf): {
			if (lookupTreeDef(conf.opts, "help", "0") != "0") {
				ruUsage(conf);
			} else {
				loaded = getTreeValues(ruLoad(conf));
				println("loaded file:");
				iter(loaded, \l -> println("file: " + l.info.file));
				parsed = ruParse(loaded, conf);
				println("parsed:");
				traverseInOrder(parsed, \name, p -> {
						println("parsed file: " + name);
						println(ruParse2s(p));
						println("=====================");
					}
				);
				quit(0);
			}
		}
		None(): { }
	}
}
