import ds/tree;
import net/url_parameter;
import sys/concurrent;

export {
	RuPlace(file : string, pos : int);
	RuConf(
		file : string,
		//findPaths : [string],
        //storePaths : [string],
        verbose : int,
		opts : Tree<string, string>,
		threadId : int,
		onError : (string, [RuPlace]) -> void
	);

	ruMakeConf(onError : (string, [RuPlace]) -> void) -> Maybe<RuConf> {
		opts = fold(getAllUrlParametersArray(), makeTree(), \acc, p -> setTree(acc, p[0], p[1]));
		file = foldTree(opts, "", \name, val, acc -> 
			if (name == "file" || val == "") {
				if (acc == "") {
					if (name == "file") val else name
				} else if (acc != val) {
					onError("target file is set up more then once: '" + val + "' and '" + acc + "'", []);
					""
				} else acc;
			} else acc
		);
		verbose = s2i(lookupTreeDef(opts, "verbose", "0"));
		if (file == "") {
			onError("target file is not set", []);
			None() 
		} else {
			Some(RuConf(file, verbose, opts, s2i(getThreadId()), onError));
		}
	}
}
