import base/dir;
import base/conf;

export {
	ruCacheDir(conf : RuConf) -> string;
	ruCachedPath(file : string, conf : RuConf) -> string;
	ruCachedFile(path : string, conf : RuConf) -> string;
}

ruCacheDir(conf : RuConf) -> string {
	russell_dir = rtrim2(getRussellDir(), "/");
	lookupTreeDef(conf.opts, "cache-dir", russell_dir + "/cache");
}

ruCachedPath(file : string, conf : RuConf) -> string {
	dir = ruCacheDir(conf) + "/" + ruDirName(file);
	ensureDirectoryExists(dir);
	ruCacheDir(conf) + "/" + strReplace(file, ":", "_CCOOLLOONN_")  + ".cache";
}

ruCachedFile(path : string, conf : RuConf) -> string {
	cache_dir = ruCacheDir(conf);
	if (!startsWith(path, cache_dir)) "" else {
		changeFileExt(
			strReplace(
				strRight(path, strlen(cache_dir)),
				"_CCOOLLOONN_", ":"
			),
			""
		);
	}
}
