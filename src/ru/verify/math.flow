import base/util/concurrent;
import ru/subst;
import ru/verify/source;

export {
	RuVerifyMathResult(
		math : RuMath,
		disproved : [RuVerifyTheoremResult]
	);
	ruVerifyMath(math : RuMath, env : RuEnv) -> RuVerifyMathResult;
}

ruVerifyMath(math : RuMath, env : RuEnv) -> RuVerifyMathResult {
	err_count = ref 0;
	timer = ruMakeTimer();
	disproved = ruVerifyTheorems(getTreeValues(ruDeclsTheorems(math.decls)), math, env);
	if (length(disproved) > 0) {
		env.out.onMessage(
			(if (ruVerbose(env.conf) > 0) "" else "ru disproved: " +i2s(length(disproved)) + " theorems in " + ruTimePassed2s(timer) + "\n") +
			"\tdisproved theorems:\n" + strGlue(map(disproved, \res -> "\t\t" + id2s(res.theorem.info.id) + "\n" + ruVerifyErrs2s(res, math) + "\n"), "\n")
		);
	}
	if (ruVerbose(env.conf) > 0) {
		env.out.onMessage("ru verified: " +i2s(sizeTree(math.sources)) + " files in " + ruTimePassed2s(timer));
	}
	RuVerifyMathResult(math, disproved);
}
