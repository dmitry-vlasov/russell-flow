import ru_server;

main() -> void {
	println("Russell prover (4th generation)");
	println("");
	switch (ruMakeConf(ruCurrentWorkingDir())) {
		Some(conf): {
			if (ruOptIsTrue("help", conf)) {
				ruUsage(conf);
				quit(0);
			} else if (ruOptIsSet("server", conf)) {
				server = ruOpt("server", conf);
				if (server == "http") {
					ruHttpServer(conf);
				} else if (server == "lsp") {
					ruConsoleServer(conf);
				} else {
					ruPrintln("unsupported server mode: " + server, conf);
					quit(0);
				}
			} else {
				ensureDirectoryExists(ruOpt("cache-dir", conf));
				start = timestamp();
				ruRun(conf, \code -> {
					ruPrintln("processed in " + d2st((timestamp() - start)/ 1000.0, 2) + "s", conf);
					quit(0);
				});
			}
		}
		None(): quit(0);
	}
}
