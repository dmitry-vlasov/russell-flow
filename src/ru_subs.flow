import ru_index;

export {
	ruUnifyCartSubs(subs : [[RuUnified<?>]]) -> [RuUnifiedVect<?>];
}

RuSubsColumn(
	rows : [RuIndex<?>]
);

RuSubsMatrix(
	cols : [RuSubsColumn<?>]
);

ruMakeSubsMatrix(subs : [[RuUnified<?>]]) -> RuSubsMatrix<?> {
	vars = set2array(fold(subs, makeSet(), \acc, ss ->
		fold(ss, acc, \ac, s ->
			mergeSets(ac, buildSet(getTreeKeys(s.sub)))
		)
	));
	make_cell = \v, ss -> {
		fold(ss, ruMakeIndex(), \ac, s ->
			switch (lookupTree(s.sub, v)) {
				Some(ex): ruSetIndex(ex, s.data, ac);
				None(): ruSetIndex(RuExp([v], -1), s.data, ac);
			}
		)
	}
	RuSubsMatrix(
		fold(vars, [], \acc, v ->
			concat(acc, 
				[RuSubsColumn(
					fold(subs, [], \ac, ss ->
						concat(ac, [make_cell(v, ss)])
					)
				)]
			)
		)
	);
}

ruUnifyCartSubs(subs : [[RuUnified<?>]]) -> [RuUnifiedVect<?>] {
	[]
}

