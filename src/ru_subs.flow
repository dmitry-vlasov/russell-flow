import ru_index;

export {
	ruUnifyCartSubs(subs : [[RuUnified<?>]], math : RuMath) -> [RuUnifiedVect<?>];
}

RuSubsColumn(
	rows : [RuIndex<?>]
);

RuSubsMatrix(
	cols : [RuSubsColumn<?>]
);

ruMakeSubsMatrix(subs : [[RuUnified<?>]]) -> RuSubsMatrix<?> {
	vars = set2array(fold(subs, makeSet(), \acc, ss ->
		fold(ss, acc, \ac, s ->
			mergeSets(ac, buildSet(getTreeKeys(s.sub)))
		)
	));
	make_cell = \v, ss -> {
		fold(ss, ruMakeIndex(), \ac, s ->
			switch (lookupTree(s.sub, v)) {
				Some(ex): ruSetIndex(ex, s.data, ac);
				None(): ruSetIndex(RuExp([v], -1), s.data, ac);
			}
		)
	}
	RuSubsMatrix(
		fold(vars, [], \acc, v ->
			concat(acc, 
				[RuSubsColumn(
					fold(subs, [], \ac, ss ->
						concat(ac, [make_cell(v, ss)])
					)
				)]
			)
		)
	);
}

ruIntersectCols(col1 : [RuUnifiedVect<?>], col2 : [RuUnifiedVect<?>]) -> [RuUnifiedVect<?>] {
	col1
}

ruUnifyCartSubs(subs : [[RuUnified<?>]], math : RuMath) -> [RuUnifiedVect<?>] {
	matrix = ruMakeSubsMatrix(subs);
	unified = map(matrix.cols, \col -> ruUnifyIndexes(col.rows, makeTree(), math));
	fold(unified, [], \acc, col -> ruIntersectCols(acc, col));
	
	/*fold(matrix.cols, [], \acc, col -> 
		unified = ruUnifyIndexes(col.rows, makeTree(), math);
	);*/
}

