import script/script;

export {
	ruLoadScript(file : string, conf : RuConf) -> Maybe<ScScript>;
}

ruFindScript(name : string, conf : RuConf) -> string {
	if (fileExists(name)) name else 
	if (fileExists(name + ".rus")) name + ".rus" else {
		scripts_dir = pathCombine(getRussellDir(), "scripts");
		if (fileExists(pathCombine(scripts_dir, name))) pathCombine(scripts_dir, name) else 
		if (fileExists(pathCombine(scripts_dir, name + ".rus"))) pathCombine(scripts_dir, name + ".rus") else {
			conf.onError("Script '" + name + "' is not found", []);
			""
		}
	}
}

ruLoadScript(name : string, conf : RuConf) -> Maybe<ScScript> {
	file = ruFindScript(name, conf);
	if (file == "" || !fileExists(file)) {
		conf.onMessage("Script '" + name + "' is not found");
		None();
	} else {
		src = getFileContent(file);
		switch (ruParseScript(src)) {
			Some(script): {
				if (ruVerbose(conf) >= 2) {
					conf.onMessage("\tScript '" + name + "' is loaded: " + ruScript2s(script));
				}
				Some(script);
			}
			None(): {
				conf.onMessage("\tSyntax error in script: '" + escapeStr(src) + "'");
				None();
			}
		}
	}
}