import script/func;
import base/util/timer;
import script/util;

export {
	ruScriptTimeFuncs() -> [ScriptFn];
}

ruScriptTimeFuncs() -> [ScriptFn] {
	[
		ScriptFn("time2s", \args, state, out -> 
			ruEvalDoubleFn(args, \as -> Some(scStringVal(ruTime2s(as[0]))),  "time2s", 1)
		),
		ScriptFn("time", \args, state, out -> 
			ruEvalValueFn(args, \as -> Some(scDoubleVal(ruTime())),  "time", 0)
		),
		ScriptFn("timer", \args, state, out -> 
			ruEvalDoubleFn(args, 
				\as -> {
					if (length(as) == 0) Some(ScValue(ruMakeTimer(), scConstType("RuTimer"))) else 
					if (length(as) == 1) Some(ScValue(ruMakeLimitedTimer(as[0]), scConstType("RuTimer"))) else None();
				}, 
				"time", -1
			)
		),
		ScriptFn("timePassed", \args, state, out ->
			ruEvalValueFn(args, 
				\as -> {
					arg = as[0];
					type = scTypeGen(arg.type);
					if (scTypeGen(arg.type) == "RuTimer") {
						timer = cast(arg.val : flow -> RuTimer);
						Some(scDoubleVal(ruTimePassed(timer)));
					} else if (scTypeGen(arg.type) == "double") {
						time = cast(arg.val : flow -> double);
						Some(scDoubleVal(ruTime() - time));
					} else {
						None();
					}
					/*switch (as[0]) {
						ScDouble(time): Some(ScDouble(ruTime() - time));
						ScData(type, data): {
							if (type != "RuTimer") None() else {
								timer = cast(data : flow -> RuTimer);
								Some(ScDouble(ruTimePassed(timer)));
							}
						}
						default: None();
					}*/
				}, 
				"timePassed", 1
			)
		),
		ScriptFn("timePassed2s", \args, state, out ->
			ruEvalValueFn(args, 
				\as -> {
					arg = as[0];
					type = scTypeGen(arg.type);
					if (scTypeGen(arg.type) == "RuTimer") {
						timer = cast(arg.val : flow -> RuTimer);
						Some(scStringVal(ruTimePassed2s(timer)));
					} else if (scTypeGen(arg.type) == "double") {
						time = cast(arg.val : flow -> double);
						Some(scStringVal(ruTime2s(ruTime() - time)));
					} else {
						None();
					}
					/*switch (as[0]) {
						ScDouble(time): Some(ScString(ruTime2s(ruTime() - time)));
						ScData(type, data): {
							if (type != "RuTimer") None() else {
								timer = cast(data : flow -> RuTimer);
								Some(ScString(ruTimePassed2s(timer)));
							}
						}
						default: None();
					}*/
				}, 
				"timePassed2s", 1
			)
		),
		ScriptFn("timeLeft", \args, state, out ->
			ruEvalValueFn(args, 
				\as -> {
					arg = as[0];
					type = scTypeGen(arg.type);
					if (scTypeGen(arg.type) == "RuTimer") {
						timer = cast(arg.val : flow -> RuTimer);
						Some(scDoubleVal(ruTimeLeft(timer)));
					} else {
						None();
					}
					/*switch (as[0]) {
						ScData(type, data): {
							if (type != "RuTimer") None() else {
								timer = cast(data : flow -> RuTimer);
								Some(ScDouble(ruTimeLeft(timer)));
							}
						}
						default: None();
					}*/
				}, "timeLeft", 1
			)
		),
	]
}