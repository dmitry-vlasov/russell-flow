import lsp/util;
import lsp/method;

export {
	ruLspTextDocumentMethods : Tree<string, RuLspMethod>;
}

ruLspTextDocumentMethods = pairs2tree([
	Pair("textDocument/didOpen", RuLspMethod(ruLspTextDocumentDidOpen, false, nop2, true)),
	Pair("textDocument/didClose", RuLspMethod(ruLspTextDocumentDidClose, false, nop2, true)),
	Pair("textDocument/didChange", RuLspMethod(ruLspTextDocumentDidChange, false, nop2, true)),
	Pair("textDocument/didSave", RuLspMethod(ruLspTextDocumentDidSave, false, nop2, true)),
	Pair("textDocument/documentSymbol", RuLspMethod(ruLspTextDocumentDocumentSymbol, true, nop2, true)),
	Pair("textDocument/declaration", RuLspMethod(ruLspTextDocumentDeclaration, true, nop2, true)),
	Pair("textDocument/definition", RuLspMethod(ruLspTextDocumentDefinition, true, nop2, true)),
	Pair("textDocument/references", RuLspMethod(ruLspTextDocumentReferences, true, nop2, true)),
	Pair("textDocument/hover", RuLspMethod(ruLspTextDocumentHover, true, nop2, true)),
	Pair("textDocument/rename", RuLspMethod(ruLspTextDocumentRename, true, nop2, true)),
	Pair("textDocument/codeAction", RuLspMethod(ruLspTextDocumentCodeAction, true, nop2, true)),
]);

ruLspTextDocumentDidOpen(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspTextDocumentItem(getJsonObjectField(json, "textDocument"))) {
		Some(textitem): {
			file = ruCorrectUriPath(textitem.uri.path);
			conf = ruLspFileConfig(env.conf, file);
			ScCommSeq([
				ScTask("conf-set", ruTree2ScTaskArgs(ruConf2Tree(conf))), 
				ScTask("cache-load", [ScTaskArg("file", ScString(file))]), 
				ScTask("sync-file-source", [
					ScTaskArg("file", ScString(file)), 
					ScTaskArg("text", ScString(textitem.text))
				])
			]);
		}
		None(): {
			env.out.onError("text document item is invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}

ruLspTextDocumentDidClose(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspTextDocumentItem(getJsonObjectField(json, "textDocument"))) {
		Some(textitem): {
			// Do nothing
			ScAction("stop", []);
		}
		None(): {
			env.out.onError("text document item is invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}

ruLspTextDocumentDidChange(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspDidChangeTextDocumentParams(json)) {
		Some(params): {
			file = ruCorrectUriPath(params.textDocument.uri.path);
			conf = ruLspFileConfig(env.conf, file);
			ScCommSeq([
				ScTask("conf-set", ruTree2ScTaskArgs(ruConf2Tree(conf))),
				ScTask("sync-file-changed", [
					ScTaskArg("file", ScString(file)), 
					ScTaskArg("change-json", ScString(json2string(json)))
				])
			]);
		}
		None(): {
			env.out.onError("text document item is invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}

ruLspTextDocumentDidSave(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspDidSaveTextDocumentParams(json)) {
		Some(params): {
			file = ruCorrectUriPath(params.textDocument.uri.path);
			conf = ruLspFileConfig(env.conf, file);
			ScCommSeq([
				ScTask("conf-set", ruTree2ScTaskArgs(ruConf2Tree(conf))),
				ScTask("sync-file-saved", [ScTaskArg("file", ScString(file))])
			]);
		}
		None(): {
			env.out.onError("text document item is invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}

ruLspTextDocumentDocumentSymbol(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspTextDocumentIdentifier(getJsonObjectField(json, "textDocument"))) {
		Some(textid): {
			file = ruCorrectUriPath(textid.uri.path);
			conf = ruLspFileConfig(env.conf, file);
			ScCommSeq([
				ScTask("conf-set", ruTree2ScTaskArgs(ruConf2Tree(conf))),
				ScTask("info-outline", [ScTaskArg("file", ScString(file))])
			]);
		}
		None(): {
			env.out.onError("text document id is invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}

ruLspTextDocumentDeclaration(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspTextDocumentPositionParams(json)) {
		Some(textpos): {
			file = ruCorrectUriPath(textpos.textDocument.uri.path);
			conf = ruLspFileConfig(env.conf, file);
			ScCommSeq([
				ScTask("conf-set", ruTree2ScTaskArgs(ruConf2Tree(conf))),
				ScTask("info-decl", [
					ScTaskArg("file", ScString(file)),
					ScTaskArg("line", ScInt(textpos.position.line)), 
					ScTaskArg("col", ScInt(textpos.position.character))
				])
			]);
		}
		None(): {
			env.out.onError("text position is invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}

ruLspTextDocumentDefinition(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspTextDocumentPositionParams(json)) {
		Some(textpos): {
			file = ruCorrectUriPath(textpos.textDocument.uri.path);
			conf = ruLspFileConfig(env.conf, file);
			ScCommSeq([
				ScTask("conf-set", ruTree2ScTaskArgs(ruConf2Tree(conf))),
				ScTask("info-decl", [
					ScTaskArg("file", ScString(file)),
					ScTaskArg("line", ScInt(textpos.position.line)), 
					ScTaskArg("col", ScInt(textpos.position.character))
				])
			]);
		}
		None(): {
			env.out.onError("text position is invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}

ruLspTextDocumentReferences(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspTextDocumentPositionParams(json)) {
		Some(textpos): {
			file = ruCorrectUriPath(textpos.textDocument.uri.path);
			conf = ruLspFileConfig(env.conf, file);
			ScCommSeq([
				ScTask("conf-set", ruTree2ScTaskArgs(ruConf2Tree(conf))),
				ScTask("info-uses", [
					ScTaskArg("file", ScString(file)),
					ScTaskArg("line", ScInt(textpos.position.line)), 
					ScTaskArg("col", ScInt(textpos.position.character))
				])
			]);
		}
		None(): {
			env.out.onError("text position is invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}

ruLspTextDocumentHover(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspTextDocumentPositionParams(json)) {
		Some(textpos): {
			file = ruCorrectUriPath(textpos.textDocument.uri.path);
			conf = ruLspFileConfig(env.conf, file);
			ScCommSeq([
				ScTask("conf-set", ruTree2ScTaskArgs(ruConf2Tree(conf))),
				ScTask("info-hover", [
					ScTaskArg("file", ScString(file)),
					ScTaskArg("line", ScInt(textpos.position.line)), 
					ScTaskArg("col", ScInt(textpos.position.character))
				])
			]);
		}
		None(): {
			env.out.onError("text position is invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}

ruLspTextDocumentRename(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspRename(json)) {
		Some(rename): {
			file = ruCorrectUriPath(rename.textDocument.uri.path);
			conf = ruLspFileConfig(env.conf, file);
			ScCommSeq([
				ScTask("conf-set", ruTree2ScTaskArgs(ruConf2Tree(conf))),
				ScTask("rename", [
					ScTaskArg("file", ScString(file)),
					ScTaskArg("line", ScInt(rename.position.line)), 
					ScTaskArg("col", ScInt(rename.position.character)),
					ScTaskArg("to", ScString(rename.newName))
				])
			]);
		}
		None(): {
			env.out.onError("text position is invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}

ruLspTextDocumentCodeAction(json : Json, env : RuEnv) -> ScComm {
	switch (json2LspCodeActionParams(json)) {
		Some(params): {
			file = ruCorrectUriPath(params.textDocument.uri.path);
			conf = ruLspFileConfig(env.conf, file);
			ScCommSeq([
				ScTask("conf-set", ruTree2ScTaskArgs(ruConf2Tree(conf))),
				ScTask("actions", [
					ScTaskArg("file", ScString(file)),
					ScTaskArg("line", ScInt(params.range.start.line)), 
					ScTaskArg("col", ScInt(params.range.start.character)),
				])
			]);
		}
		None(): {
			env.out.onError("code action params are invalid: " + json2string(json), []);
			ScAction("stop", []);
		}
	}
}
